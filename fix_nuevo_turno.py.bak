
path = r'c:\Users\alfre\OneDrive\Documentos\Agenda\agendas_medicas\static\nuevo_turno.html'
with open(path, 'r', encoding='utf-8') as f:
    lines = f.readlines()

# Find the split point at 'const dateStr ='
start_index = -1
for i, line in enumerate(lines):
    if 'const dateStr =' in line:
        start_index = i
        break

if start_index == -1:
    print('Error: Could not find split point')
    exit(1)

# Keep lines up to start_index (inclusive)
kept_lines = lines[:start_index+1]

# Append the rest
new_content = kept_lines + [
    '                                        const dayName = d.toLocaleDateString(\'es-ES\', { weekday: \'short\', day: \'numeric\', month: \'short\' });\n',
    '\n',
    '                                        const div = document.createElement(\'div\');\n',
    '                                        div.className = \'checkbox-item\';\n',
    '                                        div.innerHTML = `<input type="checkbox" name="fechas_multi" value="${dateStr}" id="d_${dateStr}"> <label for="d_${dateStr}">${dayName}</label>`;\n',
    '                                        container.appendChild(div);\n',
    '                                        count++;\n',
    '                                    }\n',
    '                                }\n',
    '\n',
    '                                async function checkAvailability() {\n',
    '                                    const agendaSelect = document.getElementById(\'agenda_id\');\n',
    '                                    const selectedOption = agendaSelect.options[agendaSelect.selectedIndex];\n',
    '                                    if (!selectedOption) {\n',
    '                                        alert(\'Seleccione una agenda.\');\n',
    '                                        return;\n',
    '                                    }\n',
    '                                    const tipo = selectedOption.dataset.tipo;\n',
    '\n',
    '                                    let fecha = document.getElementById(\'fecha\').value;\n',
    '                                    \n',
    '                                    // For Radiotherapy, get the first selected date from checkboxes if the main date input is hidden/empty\n',
    '                                    if (tipo === \'RADIOTERAPIA\') {\n',
    '                                        const checkedDates = Array.from(document.querySelectorAll(\'input[name=\"fechas_multi\"]:checked\')).map(cb => cb.value);\n',
    '                                        if (checkedDates.length > 0) {\n',
    '                                            // Sort to find the earliest date\n',
    '                                            checkedDates.sort();\n',
    '                                            fecha = checkedDates[0];\n',
    '                                        } else {\n',
    '                                            alert(\'Seleccione al menos una fecha de inicio en \"Seleccionar Días\".\');\n',
    '                                            return;\n',
    '                                        }\n',
    '                                    }\n',
    '\n',
    '                                    if (!fecha) {\n',
    '                                        alert(\'Seleccione una fecha.\');\n',
    '                                        return;\n',
    '                                    }\n',
    '\n',
    '                                    const practicasIds = Array.from(document.querySelectorAll(\'input[name=\"practicas_ids\"]:checked\')).map(cb => cb.value);\n',
    '\n',
    '                                    if (practicasIds.length === 0) {\n',
    '                                        alert(\'Seleccione al menos una práctica.\');\n',
    '                                        return;\n',
    '                                    }\n',
    '\n',
    '                                    let duracion = 15; // default\n',
    '                                    if (tipo === \'RADIOTERAPIA\') duracion = 10;\n',
    '                                    if (tipo === \'QUIMIOTERAPIA\') duracion = 60;\n',
    '                                    if (tipo === \'ECOGRAFIA\') duracion = 30;\n',
    '                                    if (tipo === \'CONSULTA_MEDICA\') duracion = 20;\n',
    '\n',
    '                                    let daysCount = 1;\n',
    '                                    if (tipo === \'RADIOTERAPIA\') {\n',
    '                                        daysCount = 20;\n',
    '                                    }\n',
    '\n',
    '                                    const btn = document.getElementById(\'btnCheckAvailability\');\n',
    '                                    const originalText = btn.textContent;\n',
    '                                    btn.textContent = \'⏳ Buscando...\';\n',
    '                                    btn.disabled = true;\n',
    '\n',
    '                                    try {\n',
    '                                        const params = new URLSearchParams({\n',
    '                                            agenda_id: agendaSelect.value,\n',
    '                                            fecha: fecha,\n',
    '                                            duracion: duracion,\n',
    '                                            days_count: daysCount\n',
    '                                        });\n',
    '                                        practicasIds.forEach(id => params.append(\'practicas_ids\', id));\n',
    '\n',
    '                                        const res = await fetch(`/turnos/available_slots?${params.toString()}`, {\n',
    '                                            headers: { \'Authorization\': `Bearer ${token}` }\n',
    '                                        });\n',
    '\n',
    '                                        if (!res.ok) throw new Error(\'Error al buscar horarios\');\n',
    '\n',
    '                                        const slots = await res.json();\n',
    '\n',
    '                                        const list = document.getElementById(\'slotsList\');\n',
    '                                        list.innerHTML = \'\';\n',
    '\n',
    '                                        if (slots.length === 0) {\n',
    '                                            list.innerHTML = \'<p style=\"grid-column: 1/-1; text-align: center; color: #e53e3e;\">No hay horarios disponibles para los parámetros seleccionados.</p>\';\n',
    '                                        } else {\n',
    '                                            slots.forEach(time => {\n',
    '                                                const btnSlot = document.createElement(\'button\');\n',
    '                                                btnSlot.type = \'button\';\n',
    '                                                btnSlot.textContent = time;\n',
    '                                                btnSlot.style.cssText = \'padding: 0.5rem; background: #ebf8ff; border: 1px solid #bee3f8; border-radius: 4px; cursor: pointer; color: #2c5282; font-weight: 500; transition: background 0.2s;\';\n',
    '                                                btnSlot.onmouseover = () => btnSlot.style.background = \'#bee3f8\';\n',
    '                                                btnSlot.onmouseout = () => btnSlot.style.background = \'#ebf8ff\';\n',
    '                                                btnSlot.onclick = () => {\n',
    '                                                    document.getElementById(\'hora\').value = time;\n',
    '                                                    document.getElementById(\'slotsModal\').style.display = \'none\';\n',
    '                                                };\n',
    '                                                list.appendChild(btnSlot);\n',
    '                                            });\n',
    '                                        }\n',
    '\n',
    '                                        document.getElementById(\'slotsInfo\').textContent = `Disponibilidad a partir del ${fecha} (${daysCount} días). Duración est: ${duracion} min.`;\n',
    '                                        document.getElementById(\'slotsModal\').style.display = \'flex\';\n',
    '\n',
    '                                    } catch (error) {\n',
    '                                        console.error(error);\n',
    '                                        alert(\'Error al buscar disponibilidad\');\n',
    '                                    } finally {\n',
    '                                        btn.textContent = originalText;\n',
    '                                        btn.disabled = false;\n',
    '                                    }\n',
    '                                }\n',
    '\n',
    '                                loadData();\n',
    '                            </script>\n',
    '                        </body>\n',
    '\n',
    '</html>\n'
]

with open(path, 'w', encoding='utf-8') as f:
    f.writelines(new_content)
