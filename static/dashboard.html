<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Agenda M√©dica</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/styles.css?v=2">
</head>

<body>
    <div class="layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="/static/logo_ccm_coc.jpg" alt="Logo" class="sidebar-logo">
                <h3>Agenda M√©dica</h3>
            </div>

            <nav class="nav-menu">
                <a href="/static/dashboard.html" class="nav-item active">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="20" height="20">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z">
                        </path>
                    </svg>
                    Dashboard
                </a>
                <a href="/static/agendas.html" class="nav-item">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="20" height="20">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                        </path>
                    </svg>
                    Agendas
                </a>
                <a href="/static/historial_turnos.html" class="nav-item">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="20" height="20">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Historial
                </a>
                <a href="/static/reporte_notificaciones.html" class="nav-item">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="20" height="20">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9">
                        </path>
                    </svg>
                    Notificaciones
                </a>

                <!-- Enlace Admin Oculto por Defecto -->
                <a href="/static/admin_users.html" class="nav-item" id="admin-link" style="display: none;">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="20" height="20">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z">
                        </path>
                    </svg>
                    Usuarios (Admin)
                </a>
            </nav>

            <button class="logout-btn" onclick="logout()"
                style="margin-top: auto; margin-bottom: 1rem; padding: 0.75rem; background: #f56565; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; width: 100%;">
                <svg style="width: 16px; height: 16px; margin-right: 8px;" fill="none" stroke="currentColor"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1">
                    </path>
                </svg>
                Cerrar Sesi√≥n
            </button>
        </aside>

        <main class="main-content">
            <header class="top-header">
                <div class="date-picker">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="20" height="20">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                        </path>
                    </svg>
                    <span id="current-date">Cargando fecha...</span>
                </div>
                <div class="user-profile">
                    <div class="avatar">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="24" height="24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z">
                            </path>
                        </svg>
                    </div>
                    <div class="user-info">
                        <p>Usuario:</p>
                        <h4 id="user-name-display">Cargando...</h4>
                    </div>
                </div>
            </header>

            <h1 class="page-title">Agenda del D√≠a</h1>

            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card blue">
                    <div>
                        <div class="stat-value" id="stat-today">-</div>
                        <div class="stat-label">Turnos Hoy</div>
                    </div>
                    <div class="stat-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="24" height="24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                </div>
                <div class="stat-card green">
                    <div>
                        <div class="stat-value" id="stat-completed">-</div>
                        <div class="stat-label">Completados</div>
                    </div>
                    <div class="stat-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="24" height="24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                </div>
                <div class="stat-card red">
                    <div>
                        <div class="stat-value" id="stat-absent">-</div>
                        <div class="stat-label">Ausentes</div>
                    </div>
                    <div class="stat-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="24" height="24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z">
                            </path>
                        </svg>
                    </div>
                </div>
                <div class="stat-card purple">
                    <div>
                        <div class="stat-value" id="stat-pending">-</div>
                        <div class="stat-label">Pendientes</div>
                    </div>
                    <div class="stat-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="24" height="24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="dashboard-layout">
                <!-- Timeline Section -->
                <div class="timeline-container">
                    <div class="timeline-header" style="margin-bottom: 1.5rem;">
                        <h2 style="font-size: 1.25rem; color: #2d3748;">Turnos Agendados</h2>
                    </div>
                    <div id="timeline-content">
                        <div style="text-align:center; padding: 2rem; color: #718096;">
                            Cargando turnos...
                        </div>
                    </div>
                </div>

                <!-- Right Sidebar Section -->
                <div class="right-sidebar">
                    <!-- Next Turn Card -->
                    <div class="next-turn-card">
                        <div class="next-turn-header">Pr√≥ximo Turno</div>
                        <div class="next-patient">
                            <div class="next-patient-avatar">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="32" height="32"
                                    style="color: white;">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z">
                                    </path>
                                </svg>
                            </div>
                            <div class="next-patient-info" id="next-patient-info">
                                <h3>-</h3>
                                <p>-</p>
                                <p style="font-size: 0.75rem; color: #ebf8ff; font-weight: 600;">-</p>
                            </div>
                        </div>
                        <div class="action-buttons">
                            <button class="btn-icon">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="20" height="20">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z">
                                    </path>
                                </svg>
                            </button>
                            <button class="btn-icon">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="20" height="20">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
                                    </path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Main Actions -->
                    <div class="main-actions">
                        <button class="btn-primary" onclick="window.location.href='/static/nuevo_turno.html'">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="20" height="20">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 4v16m8-8H4">
                                </path>
                            </svg>
                            Nuevo Turno
                        </button>
                        <button class="btn-secondary" onclick="window.location.href='/static/historial_turnos.html'">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="20" height="20">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                            Buscar Paciente
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const token = localStorage.getItem('token');

        // 1. Check token immediately but DON'T redirect yet to avoid loops if token is invalid but we want to show error.
        // However, standard behavior is redirect. We'll implement soft check.
        if (!token) {
            window.location.href = '/static/login.html';
        }

        // Set current date
        const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('current-date').textContent = new Date().toLocaleDateString('es-ES', dateOptions);

        async function loadTurnos() {
            try {
                if (!token) return;

                const response = await fetch('/turnos/?limit=100', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.status === 401) {
                    // Avoid infinite loop: alert user instead of immediate redirect
                    console.error("401 Unauthorized in loadTurnos");
                    alert("Tu sesi√≥n ha expirado. Por favor, inicia sesi√≥n nuevamente.");
                    logout();
                    return;
                }

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server Error (${response.status}): ${errorText}`);
                }

                let turnos = await response.json();

                // Normalize dates
                turnos = turnos.map(t => {
                    let fechaSolo = t.fecha;
                    if (t.fecha && t.fecha.includes('T')) {
                        fechaSolo = t.fecha.split('T')[0];
                    }
                    return { ...t, fecha: fechaSolo };
                });

                updateStats(turnos);
                renderTimeline(turnos);
                updateNextTurn(turnos);
            } catch (error) {
                console.error('Error loading turnos:', error);
                document.getElementById('timeline-content').innerHTML = `<div style="color:red; text-align:center; padding: 2rem;">
                    <p>Error al cargar datos:</p>
                    <small>${error.message}</small>
                </div>`;
            }
        }

        function updateStats(turnos) {
            // Use local date for "Today"
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const today = `${year}-${month}-${day}`;

            const todayTurnos = turnos.filter(t => t.fecha === today);
            const pending = todayTurnos.filter(t => t.estado === 'PENDIENTE');
            const completed = todayTurnos.filter(t => t.estado === 'COMPLETADO');
            const absent = todayTurnos.filter(t => t.estado === 'AUSENTE');

            document.getElementById('stat-today').textContent = todayTurnos.length;
            document.getElementById('stat-pending').textContent = pending.length;
            document.getElementById('stat-completed').textContent = completed.length;
            document.getElementById('stat-absent').textContent = absent.length;
        }

        function renderTimeline(turnos) {
            const container = document.getElementById('timeline-content');
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const today = `${year}-${month}-${day}`;

            const todayTurnos = turnos.filter(t => t.fecha === today);
            todayTurnos.sort((a, b) => a.hora.localeCompare(b.hora));

            if (todayTurnos.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#a0aec0; padding: 2rem;">No hay turnos para hoy</p>';
                return;
            }

            let html = '';
            todayTurnos.forEach(turno => {
                let cardClass = 'blue';
                if (turno.estado === 'COMPLETADO') cardClass = 'green';
                else if (turno.estado === 'PENDIENTE') cardClass = 'purple';
                else if (turno.estado === 'AUSENTE') cardClass = 'red';

                const pNombre = turno.paciente?.nombre || '';
                const pApellido = turno.paciente?.apellido || '';
                const pacienteNombre = (pNombre || pApellido) ? `${pNombre} ${pApellido}`.trim() : `ID: ${turno.paciente_id}`;

                const practicas = turno.practicas && turno.practicas.length > 0
                    ? turno.practicas.map(p => p.nombre).join(', ')
                    : 'Sin pr√°cticas';

                const obraSocial = turno.paciente && turno.paciente.obra_social
                    ? turno.paciente.obra_social.nombre
                    : 'Particular';

                html += `
                <div class="timeline-slot">
                    <div class="time-col">${turno.hora}</div>
                    <div class="event-col">
                        <div class="appointment-card ${cardClass}">
                            <div class="app-info">
                                <h4>${pacienteNombre} - ${practicas}</h4>
                                <div class="app-details">
                                    <span>üìû ${turno.paciente?.telefono || turno.paciente?.celular || 'Sin contacto'}</span>
                                    <span>‚è± ${turno.duracion || 15} min</span>
                                </div>
                                <div style="font-size: 0.75rem; margin-top: 0.5rem; opacity: 0.8;">[${turno.estado}]</div>
                            </div>
                            <div class="badge">${obraSocial}</div>
                        </div>
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }

        function updateNextTurn(turnos) {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const todayStr = `${year}-${month}-${day}`;
            const currentTime = now.toTimeString().split(' ')[0].substring(0, 5);

            const upcoming = turnos.filter(t => {
                if (t.estado !== 'PENDIENTE') return false;
                if (t.fecha > todayStr) return true;
                if (t.fecha === todayStr && t.hora > currentTime) return true;
                return false;
            });

            upcoming.sort((a, b) => {
                if (a.fecha !== b.fecha) return a.fecha.localeCompare(b.fecha);
                return a.hora.localeCompare(b.hora);
            });

            const nextPatientInfo = document.getElementById('next-patient-info');

            if (upcoming.length > 0) {
                const next = upcoming[0];
                const pNombre = next.paciente?.nombre || '';
                const pApellido = next.paciente?.apellido || '';
                const pacienteNombre = (pNombre || pApellido) ? `${pNombre} ${pApellido}`.trim() : `ID: ${next.paciente_id}`;
                const practicas = next.practicas && next.practicas.length > 0
                    ? next.practicas.map(p => p.nombre).join(', ')
                    : 'Sin pr√°cticas';

                nextPatientInfo.innerHTML = `
                    <h3>${pacienteNombre}</h3>
                    <p>${next.hora} - ${practicas}</p>
                `;
            } else {
                nextPatientInfo.innerHTML = `
                    <h3>No hay pr√≥ximos turnos</h3>
                    <p style="font-size: 0.875rem;">-</p>
                `;
            }
        }

        async function loadUser() {
            if (!token) return;
            try {
                const res = await fetch('/users/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) {
                    throw new Error(`Error ${res.status}`);
                }

                const user = await res.json();

                // Show Admin link if role is ADMIN
                if (user.role === 'ADMIN') {
                    const adminLink = document.getElementById('admin-link');
                    if (adminLink) adminLink.style.display = 'flex';
                }

                document.getElementById('user-name-display').textContent = `${user.username} (${user.role})`;

            } catch (e) {
                console.error("Auth Error:", e);
                // alert("Error obteniendo usuario: " + e.message);
            }
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/static/login.html';
        }

        // Initialize
        loadUser();
        loadTurnos();
    </script>
</body>

</html>